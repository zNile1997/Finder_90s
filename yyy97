-- ====== Services ======
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- ====== Settings ======
local playerHighlightColor = Color3.fromRGB(0, 255, 255)
local scannedBases = {} -- track base root yang sudah punya GUI
local updateInterval = 0.5 -- 2x per detik

-- ====== Helper: Ambil BasePart ======
local function getDefaultBasePart(model)
    if model:IsA("Model") then
        return model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
    elseif model:IsA("BasePart") then
        return model
    end
    return nil
end

-- ====== Helper: Cari Timer Label (ambil 1 per base root) ======
local function findTimerLabelAndPart(baseRoot)
    for _, descendant in ipairs(baseRoot:GetDescendants()) do
        if descendant:IsA("TextLabel") and descendant.Text ~= "" then
            if descendant.Text:match("^%d+s?$") then
                local adornee
                if descendant.Parent:IsA("BasePart") then
                    adornee = descendant.Parent
                else
                    adornee = descendant:FindFirstAncestorWhichIsA("BasePart") or baseRoot.PrimaryPart
                end
                return descendant, adornee
            end
        end
    end
    return nil, nil
end

-- ====== ESP Timer ======
local function createBaseESP(baseRoot, timerLabel, adorneePart)
    if not timerLabel or not adorneePart then return end

    local billboard = Instance.new("BillboardGui")
    billboard.Adornee = adorneePart
    billboard.AlwaysOnTop = true
    billboard.Size = UDim2.new(0,120,0,40)
    billboard.StudsOffset = Vector3.new(0,3,0)
    billboard.Parent = Workspace

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.SourceSansBold
    label.TextScaled = false
    label.TextSize = 20
    label.TextColor3 = Color3.new(1,1,1)
    label.TextStrokeColor3 = Color3.new(0,0,0)
    label.TextStrokeTransparency = 0
    label.Text = timerLabel.Text
    label.Parent = billboard

    -- update timer 2x/detik
    task.spawn(function()
        while timerLabel.Parent do
            local success, txt = pcall(function() return timerLabel.Text end)
            if success then
                if txt == "0" or txt == "0s" then
                    label.Text = "Unlock"
                    label.TextColor3 = Color3.fromRGB(0,255,0)
                else
                    label.Text = txt
                    label.TextColor3 = Color3.new(1,1,1)
                end
            else
                label.Text = "Locked"
                label.TextColor3 = Color3.new(1,1,1)
            end
            task.wait(updateInterval)
        end
    end)
end

-- ====== Scan Semua Base ======
local function scanAllBases()
    for _, plotBlock in ipairs(Workspace:GetDescendants()) do
        if plotBlock:IsA("Model") and plotBlock.Name == "PlotBlock" then
            local baseRoot = plotBlock.Parent
            if baseRoot and not scannedBases[baseRoot] then
                local timerLabel, adorneePart = findTimerLabelAndPart(baseRoot)
                if timerLabel and adorneePart then
                    createBaseESP(baseRoot, timerLabel, adorneePart)
                    scannedBases[baseRoot] = true
                end
            end
        end
    end
end
scanAllBases()

Workspace.DescendantAdded:Connect(function(obj)
    if obj:IsA("Model") and obj.Name == "PlotBlock" then
        local baseRoot = obj.Parent
        if baseRoot and not scannedBases[baseRoot] then
            local timerLabel, adorneePart = findTimerLabelAndPart(baseRoot)
            if timerLabel and adorneePart then
                createBaseESP(baseRoot, timerLabel, adorneePart)
                scannedBases[baseRoot] = true
            end
        end
    end
end)

-- ====== ESP Player ======
local function getCharacterBounds(char)
    local minVec = Vector3.new(math.huge, math.huge, math.huge)
    local maxVec = Vector3.new(-math.huge, -math.huge, -math.huge)
    for _, part in ipairs(char:GetDescendants()) do
        if part:IsA("BasePart") then
            local cframe = part.CFrame
            local size = part.Size
            local corners = {
                cframe * Vector3.new( size.X/2,  size.Y/2,  size.Z/2),
                cframe * Vector3.new(-size.X/2,  size.Y/2,  size.Z/2),
                cframe * Vector3.new( size.X/2, -size.Y/2,  size.Z/2),
                cframe * Vector3.new( size.X/2,  size.Y/2, -size.Z/2),
                cframe * Vector3.new(-size.X/2, -size.Y/2,  size.Z/2),
                cframe * Vector3.new(-size.X/2,  size.Y/2, -size.Z/2),
                cframe * Vector3.new( size.X/2, -size.Y/2, -size.Z/2),
                cframe * Vector3.new(-size.X/2, -size.Y/2, -size.Z/2),
            }
            for _, corner in ipairs(corners) do
                minVec = Vector3.new(math.min(minVec.X, corner.X), math.min(minVec.Y, corner.Y), math.min(minVec.Z, corner.Z))
                maxVec = Vector3.new(math.max(maxVec.X, corner.X), math.max(maxVec.Y, corner.Y), math.max(maxVec.Z, corner.Z))
            end
        end
    end
    local size = maxVec - minVec
    local center = (maxVec + minVec)/2
    return center, size
end

local function addPlayerESP(player)
    if player == LocalPlayer then return end

    local function applyCharacter(char)
        char:WaitForChild("HumanoidRootPart")
        if workspace:FindFirstChild(player.Name.."_ESP_Box") then
            workspace[player.Name.."_ESP_Box"]:Destroy()
        end
        if char:FindFirstChild("NameTag") then char.NameTag:Destroy() end

        local box = Instance.new("Part")
        box.Name = player.Name.."_ESP_Box"
        box.Anchored = true
        box.CanCollide = false
        box.Material = Enum.Material.Neon
        box.Transparency = 0.6
        box.Color = playerHighlightColor
        box.Parent = Workspace

        local conn
        conn = RunService.RenderStepped:Connect(function()
            if char.Parent then
                local center, size = getCharacterBounds(char)
                box.CFrame = CFrame.new(center)
                box.Size = size
            else
                box:Destroy()
                conn:Disconnect()
            end
        end)

        local head = char:FindFirstChild("Head")
        if head then
            local billboard = Instance.new("BillboardGui")
            billboard.Name = "NameTag"
            billboard.Adornee = head
            billboard.StudsOffset = Vector3.new(0,2.5,0)
            billboard.AlwaysOnTop = true
            billboard.Size = UDim2.new(0,50,0,20)
            billboard.Parent = Workspace

            local frame = Instance.new("Frame")
            frame.BackgroundTransparency = 0.5
            frame.BackgroundColor3 = Color3.fromRGB(0,0,0)
            frame.BorderSizePixel = 0
            frame.Size = UDim2.new(0,50,0,20)
            frame.Parent = billboard

            local corner = Instance.new("UICorner")
            corner.CornerRadius = UDim.new(0,6)
            corner.Parent = frame

            local textLabel = Instance.new("TextLabel")
            textLabel.Text = player.Name
            textLabel.TextColor3 = Color3.fromRGB(255,255,255)
            textLabel.BackgroundTransparency = 1
            textLabel.Font = Enum.Font.GothamBold
            textLabel.TextSize = 14
            textLabel.TextScaled = false
            textLabel.Parent = frame

            task.defer(function()
                local width = textLabel.TextBounds.X + 8
                local height = textLabel.TextBounds.Y + 4
                textLabel.Size = UDim2.new(0,width,0,height)
                textLabel.Position = UDim2.new(0.5,-width/2,0.5,-height/2)
                frame.Size = UDim2.new(0,width,0,height)
                billboard.Size = UDim2.new(0,width,0,height)
            end)
        end
    end

    player.CharacterAdded:Connect(applyCharacter)
    if player.Character then
        task.defer(function() applyCharacter(player.Character) end)
    end
end

for _, plr in ipairs(Players:GetPlayers()) do
    addPlayerESP(plr)
end
Players.PlayerAdded:Connect(addPlayerESP)
